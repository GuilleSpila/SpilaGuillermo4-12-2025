using examenProg;

namespace WinFormsApp1
{
    public partial class Form1 : Form
    {
        private readonly List<Cancha> _canchas = new();
        private readonly List<Socio> _socios = new();
        private readonly List<Reserva> _reservas = new();
        private readonly BindingSource _reservasBinding = new();
        private int _nextReservaId = 1;

        public Form1()
        {
            InitializeComponent();
            CargarDatosIniciales();
            CargarCombos();
            ConfigurarGrid();
        }

        private void ConfigurarGrid()
        {
            _reservasBinding.DataSource = _reservas;
            dgvReservas.DataSource = _reservasBinding;
            dgvReservas.Columns.Clear();
            dgvReservas.AutoGenerateColumns = false;
            dgvReservas.Columns.Add(new DataGridViewTextBoxColumn { DataPropertyName = nameof(Reserva.Id), HeaderText = "Id" });
            dgvReservas.Columns.Add(new DataGridViewTextBoxColumn { DataPropertyName = nameof(Reserva.CanchaId), HeaderText = "Cancha" });
            dgvReservas.Columns.Add(new DataGridViewTextBoxColumn { DataPropertyName = nameof(Reserva.SocioId), HeaderText = "Socio" });
            dgvReservas.Columns.Add(new DataGridViewTextBoxColumn { DataPropertyName = nameof(Reserva.FechaHoraInicio), HeaderText = "Inicio" });
            dgvReservas.Columns.Add(new DataGridViewTextBoxColumn { DataPropertyName = nameof(Reserva.FechaHoraFin), HeaderText = "Fin" });
        }

        private void btnRegistrar_Click(object sender, EventArgs e)
        {
            var cancha = cbCancha.SelectedItem as Cancha;
            var socio = cbSocio.SelectedItem as Socio;
            if (cancha is null || socio is null)
            {
                MessageBox.Show("Seleccione cancha y socio.");
                return;
            }
            var documento = txtDocumento.Text.Trim();
            var correo = txtCorreo.Text.Trim();
            if (string.IsNullOrWhiteSpace(documento) || string.IsNullOrWhiteSpace(correo) || !EsCorreoValido(correo))
            {
                MessageBox.Show("Complete documento y correo válidos.");
                return;
            }
            var inicio = dtpInicio.Value;
            var fin = dtpFin.Value;
            if (fin <= inicio)
            {
                MessageBox.Show("Fin debe ser mayor que inicio.");
                return;
            }
            if (!cancha.Activa)
            {
                MessageBox.Show("La cancha no está activa.");
                return;
            }
            if (HaySolapamiento(cancha.Id, inicio, fin))
            {
                MessageBox.Show("La cancha ya está reservada en ese horario.");
                return;
            }
            socio.Documento = documento;
            socio.CorreoElectronico = correo;
            var reserva = new Reserva
            {
                Id = _nextReservaId++,
                CanchaId = cancha.Id,
                SocioId = socio.Id,
                FechaHoraInicio = inicio,
                FechaHoraFin = fin
            };
            _reservas.Add(reserva);
            _reservasBinding.ResetBindings(false);
            MessageBox.Show("Reserva registrada.");
        }

        private void btnCancelar_Click(object? sender, EventArgs e)
        {
            if (dgvReservas.CurrentRow == null)
            {
                MessageBox.Show("Seleccione una reserva.");
                return;
            }
            if (dgvReservas.CurrentRow.DataBoundItem is Reserva r)
            {
                _reservas.Remove(r);
                _reservasBinding.ResetBindings(false);
                MessageBox.Show("Reserva cancelada.");
            }
        }

        private bool HaySolapamiento(int canchaId, DateTime inicio, DateTime fin)
        {
            // Se considera solapamiento si hay intersección de intervalos [inicio, fin)
            return _reservas.Any(r => r.CanchaId == canchaId && r.FechaHoraInicio < fin && inicio < r.FechaHoraFin);
        }

        private bool EsCorreoValido(string correo)
        {
            try
            {
                var addr = new System.Net.Mail.MailAddress(correo);
                return addr.Address == correo;
            }
            catch
            {
                return false;
            }
        }

        private void CargarDatosIniciales()
        {
            _canchas.AddRange(new[]
            {
                new Cancha { Id = 1, Nombre = "Cancha Futbol1", Tipo = TipoCancha.Futbol, Activa = true },
                new Cancha { Id = 2, Nombre = "Cancha Tenis1", Tipo = TipoCancha.Tenis, Activa = true },
                new Cancha { Id = 3, Nombre = "Cancha Padel1", Tipo = TipoCancha.Padel, Activa = true },
            });

            _socios.AddRange(new[]
            {
                new Socio { Id = 1, Nombre = "Juan Perez", Documento = "12345678", CorreoElectronico = "juan@example.com" },
                new Socio { Id = 2, Nombre = "Maria Gomez", Documento = "87654321", CorreoElectronico = "maria@example.com" },
            });
        }

        private void CargarCombos()
        {
            cbCancha.DataSource = _canchas.Where(c => c.Activa).ToList();
            cbCancha.DisplayMember = nameof(Cancha.Nombre);
            cbCancha.ValueMember = nameof(Cancha.Id);

            cbSocio.DataSource = _socios.ToList();
            cbSocio.DisplayMember = nameof(Socio.Nombre);
            cbSocio.ValueMember = nameof(Socio.Id);
        }
    }
}
