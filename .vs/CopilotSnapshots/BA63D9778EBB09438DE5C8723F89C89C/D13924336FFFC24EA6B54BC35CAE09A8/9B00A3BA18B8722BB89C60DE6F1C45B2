using examenProg;
using Microsoft.EntityFrameworkCore;

namespace WinFormsApp1
{
    public partial class Form1 : Form
    {
        private readonly BindingSource _reservasBinding = new();

        public Form1()
        {
            InitializeComponent();
            PoblarCanchasMenu();
            CargarSocios();
            ConfigurarGrid();
            RefrescarGrid();
        }

        private void PoblarCanchasMenu()
        {
            cbCancha.Items.Clear();
            cbCancha.Items.Add(TipoCancha.Futbol.ToString());
            cbCancha.Items.Add(TipoCancha.Tenis.ToString());
            cbCancha.Items.Add(TipoCancha.Padel.ToString());
            if (cbCancha.Items.Count > 0) cbCancha.SelectedIndex = 0;
        }

        private Cancha? ObtenerCanchaPorTipoSeleccionado()
        {
            if (cbCancha.SelectedItem is not string tipoStr) return null;
            if (!Enum.TryParse<TipoCancha>(tipoStr, out var tipo)) return null;
            using var db = new AppDbContext();
            return db.Canchas.Where(c => c.Activa && c.Tipo == tipo).OrderBy(c => c.Nombre).FirstOrDefault();
        }

        private void CargarSocios()
        {
            using var db = new AppDbContext();
            cbSocio.DataSource = db.Socios.OrderBy(s => s.Nombre).ToList();
            cbSocio.DisplayMember = nameof(Socio.Nombre);
            cbSocio.ValueMember = nameof(Socio.Id);
        }

        private void ConfigurarGrid()
        {
            dgvReservas.AutoGenerateColumns = false;
            dgvReservas.Columns.Clear();
            dgvReservas.Columns.Add(new DataGridViewTextBoxColumn { DataPropertyName = "ReservaId", HeaderText = "Reserva" });
            dgvReservas.Columns.Add(new DataGridViewTextBoxColumn { DataPropertyName = "Socio", HeaderText = "Socio" });
            dgvReservas.Columns.Add(new DataGridViewTextBoxColumn { DataPropertyName = "Documento", HeaderText = "Documento" });
            dgvReservas.Columns.Add(new DataGridViewTextBoxColumn { DataPropertyName = "Correo", HeaderText = "Correo electrónico" });
            dgvReservas.Columns.Add(new DataGridViewTextBoxColumn { DataPropertyName = "Cancha", HeaderText = "Cancha" });
            dgvReservas.Columns.Add(new DataGridViewTextBoxColumn { DataPropertyName = "Inicio", HeaderText = "Inicio" });
            dgvReservas.Columns.Add(new DataGridViewTextBoxColumn { DataPropertyName = "Fin", HeaderText = "Fin" });
            dgvReservas.Columns.Add(new DataGridViewTextBoxColumn { DataPropertyName = "Estado", HeaderText = "Estado" });
            dgvReservas.DataSource = _reservasBinding;
        }

        private void RefrescarGrid()
        {
            using var db = new AppDbContext();
            var hoy = DateOnly.FromDateTime(DateTime.Now);
            var now = DateTime.Now;
            var vigentesHoy = db.Reservas
                .Include(r => r.Socio)
                .Include(r => r.Cancha)
                .Where(r => DateOnly.FromDateTime(r.FechaHoraInicio) == hoy || DateOnly.FromDateTime(r.FechaHoraFin) == hoy)
                .AsEnumerable()
                .Select(r => new
                {
                    ReservaId = r.Id,
                    Socio = r.Socio?.Nombre ?? "-",
                    Documento = r.Socio?.Documento ?? "-",
                    Correo = r.Socio?.CorreoElectronico ?? "-",
                    Cancha = r.Cancha?.Nombre ?? "-",
                    Inicio = r.FechaHoraInicio,
                    Fin = r.FechaHoraFin,
                    Estado = now >= r.FechaHoraInicio && now < r.FechaHoraFin ? "En curso" : now < r.FechaHoraInicio ? "Pendiente" : "Finalizado"
                })
                .OrderBy(v => v.Inicio)
                .ToList();
            _reservasBinding.DataSource = vigentesHoy;
            _reservasBinding.ResetBindings(false);
        }

        private void btnRegistrar_Click(object sender, EventArgs e)
        {
            using var db = new AppDbContext();
            var cancha = ObtenerCanchaPorTipoSeleccionado();
            var socio = cbSocio.SelectedItem as Socio;
            if (cancha is null) { MessageBox.Show("Seleccione cancha."); return; }
            if (socio is null) { MessageBox.Show("Seleccione un socio."); return; }
            var inicio = dtpInicio.Value; var fin = dtpFin.Value;
            if (fin <= inicio) { MessageBox.Show("Fin > Inicio."); return; }
            if (!cancha.Activa) { MessageBox.Show("La cancha no está activa."); return; }
            var haySolape = db.Reservas.Any(r => r.CanchaId == cancha.Id && r.FechaHoraInicio < fin && inicio < r.FechaHoraFin);
            if (haySolape) { MessageBox.Show("La cancha ya está reservada en ese horario."); return; }
            db.Reservas.Add(new Reserva { CanchaId = cancha.Id, SocioId = socio.Id, FechaHoraInicio = inicio, FechaHoraFin = fin });
            db.SaveChanges();
            RefrescarGrid();
            MessageBox.Show("Reserva registrada.");
        }

        private void btnRegistrarSocio_Click(object sender, EventArgs e)
        {
            var nombre = txtNuevoNombre.Text.Trim();
            var documento = txtNuevoDocumento.Text.Trim();
            var correo = txtNuevoCorreo.Text.Trim();
            if (string.IsNullOrWhiteSpace(nombre)) { MessageBox.Show("Ingrese nombre."); return; }
            if (string.IsNullOrWhiteSpace(documento)) { MessageBox.Show("Ingrese documento."); return; }
            if (string.IsNullOrWhiteSpace(correo) || !EsCorreoValido(correo)) { MessageBox.Show("Ingrese correo válido."); return; }
            using var db = new AppDbContext();
            db.Socios.Add(new Socio { Nombre = nombre, Documento = documento, CorreoElectronico = correo });
            db.SaveChanges();
            CargarSocios();
            MessageBox.Show("Socio registrado.");
            txtNuevoNombre.Clear(); txtNuevoDocumento.Clear(); txtNuevoCorreo.Clear();
        }

        private void btnCancelar_Click(object sender, EventArgs e)
        {
            if (dgvReservas.CurrentRow == null) { MessageBox.Show("Seleccione una reserva."); return; }
            var id = (int)dgvReservas.CurrentRow.Cells[0].Value;
            using var db = new AppDbContext();
            var r = db.Reservas.Find(id);
            if (r is null) { MessageBox.Show("No se encontró la reserva."); return; }
            db.Reservas.Remove(r);
            db.SaveChanges();
            RefrescarGrid();
            MessageBox.Show("Reserva cancelada.");
        }

        private void btnReporte_Click(object sender, EventArgs e)
        {
            using var db = new AppDbContext();
            var reporte = db.Reservas
                .GroupBy(r => r.CanchaId)
                .Select(g => new
                {
                    Cancha = db.Canchas.Where(c => c.Id == g.Key).Select(c => c.Nombre).FirstOrDefault() ?? "-",
                    Tipo = db.Canchas.Where(c => c.Id == g.Key).Select(c => c.Tipo).FirstOrDefault().ToString() ?? "-",
                    Cantidad = g.Count()
                })
                .OrderByDescending(x => x.Cantidad)
                .ToList();
            dgvReporte.DataSource = reporte;
        }

        private bool EsCorreoValido(string correo)
        {
            try { var addr = new System.Net.Mail.MailAddress(correo); return addr.Address == correo; } catch { return false; }
        }
    }
}
